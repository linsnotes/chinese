<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中学华文词语表</title>
  <style>
    /* Global Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif; /* Sets the default font */
    }

    body {
      background-color: #f5f5f5; /* Light gray background */
      color: #3c3c3c; /* Dark gray text color */
      line-height: 1.6; /* Increases line height for readability */
      min-height: 100vh; /* Ensures body takes at least full viewport height */
      display: flex;
      flex-direction: column; /* Stacks header and main vertically */
    }

    /* Typography */
    h1 {
      margin: 0;
    }

    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    /* Utility Classes */
    .hidden {
      display: none;
    }

    .separator {
      color: #9e002a; /* Dark red color for the separator */
      font-weight: bold; /* Makes the separator text bold */
    }

    /* Header */
    header {
      background-color: #003d5c; /* Deep blue background */
      color: #ffffff; /* White text color for contrast */
      text-align: center; /* Centers the header content */
      padding: 1rem; /* Padding around the header content */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Adds subtle shadow below header */
    }

    /* Main Content Area */
    main {
      flex: 1; /* Allows main to grow and fill available space */
      padding: 2rem 1rem; /* Padding around main content */
      display: flex;
      flex-wrap: wrap; /* Allows content to wrap to next line if necessary */
      justify-content: center; /* Centers content horizontally */
      align-items: flex-start; /* Aligns items to the top */
      gap: 1.5rem; /* Space between child elements */
    }

    /* Sections */
    .form-section,
    .result-section {
      background: #ffffff; /* White background for clarity */
      padding: 2rem; /* Padding inside sections */
      border-radius: 10px; /* Rounded corners */
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
      max-width: 600px; /* Maximum width for readability */
      width: 100%; /* Full width of parent container */
    }

    .form-section {
      flex: 1; /* Allows form section to grow if needed */
    }

    .result-section {
      flex: 1.5; /* Makes result section slightly larger for content */
    }

    /* Form Elements */
    form {
      width: 100%;
    }

    fieldset {
      border: 1px solid #b0b0b0; /* Light gray border */
      border-radius: 6px; /* Rounded corners */
      padding: 1rem; /* Padding inside fieldset */
      margin-bottom: 2rem; /* Space below each fieldset */
      background-color: #ffffff; /* White background */
    }

    legend {
      font-size: 1rem; /* Standard font size */
      font-weight: bold; /* Bold text */
      color: #3c3c3c; /* Neutral text color */
      margin-bottom: 0.5rem; /* Space below the legend */
      padding: 0 0.5rem; /* Horizontal padding */
    }

    .filter-box {
      color: #467482;
    }

    .search-box {
      color: #078939;
    }

    .filter-legend {
      color: #005973; /* Dark blue color */
    }

    .search-legend {
      color: #078939; /* Green color */
    }

    .input-label {
      display: block; /* Labels act as block elements */
      margin-bottom: 0.5rem; /* Space below the label */
      font-weight: bold; /* Bold text */
      font-size: 1rem; /* Standard font size */
    }

    .dropdown,
    .submit-btn,
    #searchText {
      width: 100%; /* Full width */
      padding: 0.6rem; /* Padding inside inputs */
      margin-bottom: 1.5rem; /* Space below inputs */
      border: 1px solid #b0b0b0; /* Light gray border */
      border-radius: 5px; /* Rounded corners */
      font-size: 1rem; /* Standard font size */
    }

    .dropdown:focus,
    .submit-btn:focus,
    #searchText:focus {
      outline: none; /* Removes default outline */
      border-color: #00799e; /* Blue border on focus */
      box-shadow: 0 0 5px rgba(0, 121, 158, 0.5); /* Glow effect on focus */
    }

    /* Submit Button */
    .submit-btn {
      background-color: #00799e; /* Bright blue background */
      color: #ffffff; /* White text */
      font-weight: bold; /* Bold text */
      cursor: pointer; /* Pointer cursor on hover */
      transition: background-color 0.3s; /* Smooth background transition */
    }

    .submit-btn:hover {
      background-color: #005973; /* Darker blue on hover */
    }

    /* Search Message */
    #searchMessage {
      margin-top: 0; /* Removes margin above the message */
      padding: 0.5rem; /* Padding inside the message box */
      border: 1px solid #078939; /* Green border for emphasis */
      border-radius: 5px; /* Rounded corners */
      background-color: #ffffff; /* White background */
      font-size: 1rem; /* Standard font size */
      color: #3c3c3c; /* Subtle text color */
      text-align: center; /* Centers the text */
    }

    #searchWord {
      color: #9e002a; /* Dark red color */
      font-weight: bolder; /* Extra bold text */
    }

    #searchWord::before {
      content: ' “';
    }

    #searchWord::after {
      content: '” ';
    }

    /* Result List */
    .result-list {
      list-style: none; /* Removes bullet points */
      padding-left: 0; /* Removes left padding */
    }

    .result-item {
      margin-bottom: 1rem; /* Space below each item */
      padding: 0.5rem; /* Padding inside each item */
      border-bottom: 1px solid #9e0909; /* Red border at the bottom */
    }

    .result-key {
      font-weight: bold; /* Bold text */
      display: inline-block; /* Inline block for proper spacing */
      margin-right: 0.5rem; /* Space to the right */
    }

    .result-array {
      color: #555; /* Gray color for array items */
    }

    /* Responsive Design */
    /* Mobile Styles (Default) */
    main {
      flex-direction: column; /* Stack elements vertically */
      align-items: center; /* Center-aligns items */
      padding: 2rem 1rem; /* Padding around main content */
      gap: 1.5rem; /* Space between sections */
    }

    .form-section,
    .result-section {
      width: 100%; /* Full width */
      max-width: 550px; /* Max width for readability */
    }

    /* Tablet Styles */
    @media (min-width: 768px) {
      main {
        padding: 3rem 2rem;
      }
    }

    /* Desktop Styles */
    @media (min-width: 1024px) {
      main {
        flex-direction: row; /* Side-by-side layout */
        justify-content: space-between; /* Space between sections */
        align-items: flex-start; /* Aligns items to the top */
        gap: 2rem; /* Increased space between sections */
      }

      .form-section,
      .result-section {
        max-width: none; /* Removes max-width constraint */
      }

      .form-section {
        flex: 1; /* Form takes up one part */
      }

      .result-section {
        flex: 2; /* Results take up two parts */
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>中学华文词语表</h1>
  </header>

  <main>
    <section id="form-container" class="form-section">
      <form id="wordForm">

        <fieldset class="filter-box">

          <legend class="filter-legend">词语表范围 (Scope)</legend>

          <label for="category" class="input-label">类别 Word or Phrase</label>
          <select id="category" name="category" class="dropdown">
            <option value="">点击选择 Click to Select</option>
            <option value="词语">词语 Word</option>
            <option value="名言俗语">名言俗语 Phrase</option>
          </select>



          <label for="fetchType" class="input-label">筛选 Filter</label>
          <select id="fetchType" name="fetchType" class="dropdown">
            <option value="">点击选择 Click to Select</option>
            <option value="banding">科目 By Course</option>
            <option value="level">年级 By Level</option>
            <option value="unit">单元 By Unit</option>
            <option value="passage">课文 By Passage</option>
          </select>

          <div class="dropdown-container hidden" id="bandingContainer">
            <label for="banding" class="input-label">科目 Course</label>
            <select id="banding" name="banding" class="dropdown">
              <option value="">点击选择 Click to Select</option>
              <option value="G3">G3</option>
              <option value="G2">G2</option>
              <option value="G1">G1</option>
              <option value="HCL">HCL</option>
            </select>
          </div>
  
  
          <div class="dropdown-container hidden" id="levelContainer">
            <label for="level" class="input-label">年级 Level</label>
            <select id="level" name="level" class="dropdown">
              <option value="">点击选择 Click to Select</option>
              <option value="中一">中一</option>
              <option value="中二">中二</option>
              <option value="中三">中三</option>
              <option value="中四">中四</option>
            </select>
          </div>
  
  
  
          <div class="dropdown-container hidden" id="unitContainer">
            <label for="unit" class="input-label">单元 Unit</label>
            <select id="unit" name="unit" class="dropdown">
              <option value="">点击选择 Click to Select</option>
              <option value="单元一">单元一</option>
              <option value="单元二">单元二</option>
              <option value="单元三">单元三</option>
              <option value="单元四">单元四</option>
              <option value="单元五">单元五</option>
              <option value="单元六">单元六</option>
            </select>
          </div>
  
  
          <div class="dropdown-container hidden" id="passageContainer">
            <label for="passage" class="input-label">课文 Passage</label>
            <select id="passage" name="passage" class="dropdown">
              <option value="">点击选择 Click to Select</option>
              <option value="生活空间">生活空间</option>
              <option value="核心">核心</option>
              <option value="巩固">巩固</option>
              <option value="进阶">进阶</option>
            </select>
          </div>
        </fieldset>


        <fieldset class="search-box">

          <legend class="search-legend">搜索文本 Search Text</legend>
        <label for="searchText" class="input-label"></label>
        <input type="text" id="searchText" name="searchText" class="dropdown" placeholder="输入搜索文本 Enter text to search">
        <div id="searchMessage" class="dropdown hidden">找到<span id="matchCount"></span>篇课文包含<span id="searchWord"></span></div>
        </fieldset>



        <button type="submit" class="submit-btn">查找 Fetch Words</button>
      </form>
    </section>

    <section id="result-container" class="result-section">
      <h2>词语表</h2>
      <div id="result"></div>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Function to reset visibility on page load
      function resetVisibility() {
        const containers = document.querySelectorAll('.dropdown-container');
        containers.forEach(container => container.classList.add('hidden'));
      }
    
      // Configuration object for fetchType
      const fetchTypeConfig = {
        banding: ['bandingContainer'],
        level: ['bandingContainer', 'levelContainer'],
        unit: ['bandingContainer', 'levelContainer', 'unitContainer'],
        passage: ['bandingContainer', 'levelContainer', 'unitContainer', 'passageContainer'],
      };
    
      // Event listener for fetchType change
      document.getElementById("fetchType").addEventListener("change", function () {
        const fetchType = this.value;
    
        resetVisibility();
    
        if (fetchTypeConfig[fetchType]) {
          fetchTypeConfig[fetchType].forEach(id => {
            document.getElementById(id).classList.remove('hidden');
          });
        }
      });
    
      // Event listeners for category and fetchType change to clear search text
      ['category', 'fetchType'].forEach(id => {
        document.getElementById(id).addEventListener("change", clearSearchText);
      });
    
      function clearSearchText() {
        document.getElementById("searchText").value = "";
      }
    
      // Event listener for searchText input to reset dropdowns
      document.getElementById("searchText").addEventListener("input", function () {
        document.getElementById("category").value = "";
        document.getElementById("fetchType").value = "";
        resetVisibility();
      });
    
      // Fetch client IP once when the page loads (optional)
      let clientIP = "unknown";
      (async function fetchClientIP() {
        try {
          const res = await fetch("https://api.ipify.org?format=json");
          const data = await res.json();
          clientIP = data.ip;
        } catch (error) {
          clientIP = "unknown";
        }
      })();
    
      // Event listener for form submission
      document.getElementById("wordForm").addEventListener("submit", async function (e) {
        e.preventDefault(); // Prevent default form submission
    
        const params = new URLSearchParams();
        const searchText = document.getElementById("searchText").value.trim();
        const searchMessage = document.getElementById("searchMessage");
        const matchCount = document.getElementById("matchCount");
        const searchWord = document.getElementById("searchWord");
    
        // Hide the message initially
        searchMessage.classList.add("hidden");
    
        let isTextSearch = false; // Flag to track if this is a text-based search
    
        if (searchText) {
          // Add text-based search to the parameters
          params.append("text", searchText);
          isTextSearch = true;
        } else {
          // Proceed with dropdown filter logic if no searchText is provided
          const fetchType = document.getElementById("fetchType").value;
    
          if (fetchType) {
            params.append("category", document.getElementById("category").value || "");
            params.append("banding", document.getElementById("banding").value || "");
    
            if (["level", "unit", "passage"].includes(fetchType)) {
              params.append("level", document.getElementById("level").value || "");
            }
            if (["unit", "passage"].includes(fetchType)) {
              params.append("unit", document.getElementById("unit").value || "");
            }
            if (fetchType === "passage") {
              params.append("passage", document.getElementById("passage").value || "");
            }
          }
        }
    
        // Append client IP
        params.append("clientIP", clientIP);
    
        // Fetch data from backend
        const url = `https://script.google.com/macros/s/AKfycbwwRp7bTxcf-H4parNfokCbDqnHB6w4IFNw3OSuupBjJfxq6X32he_ayvT4hqXYke6G/exec?${params.toString()}`;
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
    
          const resultContainer = document.getElementById("result");
          resultContainer.innerHTML = ""; // Clear previous result
    
          if (data.groupedData) {
            // Show the search message ONLY for text-based searches
            if (isTextSearch) {
              matchCount.textContent = data.count || 0;
              searchWord.textContent = searchText || "";
              searchMessage.classList.remove("hidden");
            }
    
            resultContainer.appendChild(renderHierarchy(data.groupedData));
          } else {
            searchMessage.classList.add("hidden");
            resultContainer.innerText = "No words found.";
          }
        } catch (error) {
          searchMessage.classList.add("hidden");
          document.getElementById("result").innerText = `Error: ${error.message}`;
        }
      });
    
      // Recursive function to render hierarchical data
      function renderHierarchy(data) {
        const container = document.createElement("ul");
        container.classList.add("result-list");
    
        Object.entries(data).forEach(([key, value]) => {
          const listItem = document.createElement("li");
          listItem.classList.add("result-item");
          listItem.innerHTML = `<span class="result-key">${key}:</span>`;
    
          if (typeof value === "object" && !Array.isArray(value)) {
            const nestedList = renderHierarchy(value);
            listItem.appendChild(nestedList);
          } else if (Array.isArray(value)) {
            const arrayContent = document.createElement("span");
            arrayContent.classList.add("result-array");
            arrayContent.innerHTML = value
              .map(item => `<span class="array-item">${item}</span>`)
              .join('<span class="separator"> | </span>');
            listItem.appendChild(arrayContent);
          }
    
          container.appendChild(listItem);
        });
    
        return container;
      }
    
    });
    </script>
    
</body>
</html>
